

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Continuous Integration &mdash; IATI Partner Search  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Preprocessing" href="../code_documentation/" />
    <link rel="prev" title="Check the CSV Encoding with IATI.Cloud" href="../check_iati_encoding/" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../" class="icon icon-home"> IATI Partner Search
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../readme/">IATI Partner Search</a></li>
</ul>
<p class="caption"><span class="caption-text">An Overview of IATI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/">IATI Tooling Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../challenges/">Challenges of working with IATI Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Search and NLP Approaches</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../IATI_methods/">IATI Approaches Overview</a></li>
</ul>
<p class="caption"><span class="caption-text">Analysis and Progress Reports</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../count_words/">Word Count Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_download_comparison/">Data Source Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../check_iati_encoding/">Check the CSV Encoding with IATI.Cloud</a></li>
</ul>
<p class="caption"><span class="caption-text">Code:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Continuous Integration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#elasticsearch">Elasticsearch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#data-wrangling">Data Wrangling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#updating-elasticsearch-using-github-actions">Updating Elasticsearch using Github Actions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../code_documentation/">Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code_documentation/#module-ips_python.vectorize">Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code_documentation/#module-ips_python.refinement">Results Refinement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code_documentation/#module-ips_python.script">Runtime Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code_documentation/#module-ips_python.utils">Package Utilities</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">IATI Partner Search</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../">Docs</a> &raquo;</li>
        
      <li>Continuous Integration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/continuous_integration.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="continuous-integration">
<h1>Continuous Integration<a class="headerlink" href="#continuous-integration" title="Permalink to this headline">¶</a></h1>
<div class="section" id="elasticsearch">
<h2>Elasticsearch<a class="headerlink" href="#elasticsearch" title="Permalink to this headline">¶</a></h2>
<p>The fields that are indexed into the elasticsearch cluster can be found in <code class="docutils literal notranslate"><span class="pre">constants.py</span></code></p>
<p>All the documents are re-indexed every cycle. As we are using the <code class="docutils literal notranslate"><span class="pre">id</span></code> given by the IATI API (note, this is <em>not</em> the same as the activity Identifier) as the id in elasticsearch it will ignore any that it has seen before so documents that are already indexed won’t be added again. They will be added to the <code class="docutils literal notranslate"><span class="pre">docs.deleted</span></code> on the index (viewable at <code class="docutils literal notranslate"><span class="pre">_cat/indices?v</span></code>) but this appears to be cleaned up by elasticsearch (<a class="reference external" href="https://discuss.elastic.co/t/purge-the-deleted-documents-on-disk/19768">1</a>, <a class="reference external" href="https://github.com/elastic/elasticsearch/issues/30237">2</a>) so we don’t have to do any work ourselves.</p>
<div class="section" id="data-wrangling">
<h3>Data Wrangling<a class="headerlink" href="#data-wrangling" title="Permalink to this headline">¶</a></h3>
<p>We use the IATI.Cloud data, which is stored as a CSV.
We are then faced with the challenge of reading this data to a pandas dataframe, converting it to a python dict, which is then passed to the <code class="docutils literal notranslate"><span class="pre">elasticsearch</span></code> python library and uploaded to Elasticsearch, using JSON.
The IATI data contains missing values, which need to be dealt with.
The first thing we do is let the Elasticseach instance know that it should accept missing values. This can either be done with the following cURL request:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl --location --request PUT <span class="s1">&#39;&lt;ELASTICSEARCH_URL&gt;&#39;</span> <span class="se">\</span>
    --header <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="se">\</span>
    --data-raw <span class="s1">&#39;{</span>
<span class="s1">    &quot;settings&quot;: {</span>
<span class="s1">        &quot;index.mapping.ignore_malformed&quot;: true</span>
<span class="s1">    }</span>
<span class="s1">}&#39;</span>
</pre></div>
</div>
<p>or you can use the python library, which we’ve wrapped with the <code class="docutils literal notranslate"><span class="pre">ensure_elasticsearch_keeps_malformed_fields</span></code> function in the <code class="docutils literal notranslate"><span class="pre">upload_to_elasticsearch.py</span></code> file.</p>
<p>The next issue we ran in to was that Elasticsearch was not automatically handling the missing values that we passed it, because we were using pandas to handle the data.
In this case, missing values that were interpreted as <code class="docutils literal notranslate"><span class="pre">NaN</span></code> numpy objects or <code class="docutils literal notranslate"><span class="pre">None</span></code> in the Python code, were not handled when we uploaded them to Elasticsearch.</p>
<p>This issue can be replicated with the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">elasticsearch</span> <span class="kn">import</span> <span class="n">helpers</span>
<span class="kn">from</span> <span class="nn">elasticsearch</span> <span class="kn">import</span> <span class="n">Elasticsearch</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">ips_python.upload_to_elasticsearch</span> <span class="kn">import</span> <span class="n">document_generator</span>

<span class="n">ELASTICSEARCH_URL</span><span class="o">=</span><span class="s2">&quot;&lt;CHANGEME&gt;&quot;</span>
<span class="n">ELASTICSEARCH_INDEX_NAME</span><span class="o">=</span><span class="s2">&quot;&lt;CHANGEME&gt;&quot;</span>

<span class="k">def</span> <span class="nf">create_dataframe_iteratable</span><span class="p">(</span><span class="n">dataframe_iterator</span><span class="p">):</span>
    <span class="n">dataframe</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">dataframe_iterator</span><span class="p">:</span>
        <span class="k">yield</span> <span class="p">{</span><span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="n">elasticsearch_index_name</span><span class="p">,</span> <span class="s2">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;_doc&quot;</span><span class="p">,</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">document</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">document</span><span class="p">}</span>

<span class="n">elasticsearch_instance</span> <span class="o">=</span> <span class="n">Elasticsearch</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">ELASTICSEARCH_URL</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">]],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;baz&quot;</span><span class="p">])</span>


<span class="n">helpers</span><span class="o">.</span><span class="n">bulk</span><span class="p">(</span><span class="n">elasticsearch_instance</span><span class="p">,</span> <span class="n">create_dataframe_iteratable</span><span class="p">(</span><span class="n">dataframe</span><span class="p">))</span>
</pre></div>
</div>
<p>This will throw an error when the python client attempts to upload the data.
Instead we must transform these missing data to empty strings.
This can be done with the <code class="docutils literal notranslate"><span class="pre">fillna</span></code> pandas method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">]],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;baz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>The upload should now work.
See the <code class="docutils literal notranslate"><span class="pre">ips_python/upload_to_elasticsearch.py</span></code> file for more details on how this is solved.</p>
</div>
<div class="section" id="updating-elasticsearch-using-github-actions">
<h3>Updating Elasticsearch using Github Actions<a class="headerlink" href="#updating-elasticsearch-using-github-actions" title="Permalink to this headline">¶</a></h3>
<p>We use Github Actions to update the data on the Elasticsearch server.
See the <code class="docutils literal notranslate"><span class="pre">.github/workflows/updateelasticsearch.yml</span></code> file for details on how to do this.
<a class="reference external" href="https://help.github.com/en/actions/automating-your-workflow-with-github-actions/persisting-workflow-data-using-artifacts">This doc</a> on workflow artifacts is helpful in understanding what is going on.
You can see the Actions and worklows for this project <a class="reference external" href="https://github.com/datasciencecampus/iati-partner-search/actions">here</a>.</p>
<p>This Action is triggered by a timer, the frequency may change, so check the <code class="docutils literal notranslate"><span class="pre">on</span></code> field.
It would look something like this in the <code class="docutils literal notranslate"><span class="pre">updateelasticsearch.yml</span></code> file:</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>on:
  schedule:
    - cron:  &#39;0 1 * * *&#39;
</pre></div>
</div>
<p>To understand how the timing is set, see the <a class="reference external" href="https://help.github.com/en/actions/automating-your-workflow-with-github-actions/events-that-trigger-workflows#scheduled-events-schedule">Github scheduling events documentation</a>.</p>
<p>Note that we store the production Elasticsearch URL using <a class="reference external" href="https://help.github.com/en/actions/automating-your-workflow-with-github-actions/creating-and-using-encrypted-secrets">Github Secrets</a> within the Github Action.
In the event that the URL changes, a repository administrator will need to delete and re-create the secret called <code class="docutils literal notranslate"><span class="pre">ELASTICSEARCH_URL</span></code>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../code_documentation/" class="btn btn-neutral float-right" title="Preprocessing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../check_iati_encoding/" class="btn btn-neutral float-left" title="Check the CSV Encoding with IATI.Cloud" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Department for International Development

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>