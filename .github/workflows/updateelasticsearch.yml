name: Update ElasticSearch Instance

on:
  schedule:
    - cron: "0 1 * * *"  # every day at 1am

jobs:
  download_data:
    name: Download and store data from IATI.cloud
    runs-on: ubuntu-latest
    steps:
      - name: Get the Code
        uses: actions/checkout@v1
      - name: Setup Python
        uses: actions/setup-python@v1
        with:
          python-version: 3.7
      - name: Install Packages
        # we pip install only the 3 packages to reduce the time the install stage takes
        run: |
          pip install invoke requests humanfriendly
      - name: Download the Data From IATI.Cloud
        run: invoke download-data
      - name: Upload IATI Data to Github Artifacts
        uses: actions/upload-artifact@v1
        with:
          name: data
          path: data/all_downloaded_records.csv

  refresh_data_on_elasticsearch:
    name: Refresh Data on Elasticsearch Instance
    needs:
      - download_data
    runs-on: ubuntu-latest
    steps:
      - name: Get the Code
        uses: actions/checkout@v1
      - name: Get the Data From Github Artifacts
        uses: actions/download-artifact@v1
        with:
          name: data
      - name: Setup Python
        uses: actions/setup-python@v1
        with:
          python-version: 3.7
      - name: Install Packages
        run: |
          pip install invoke
          invoke install-dependencies
      - name: Upload New Data to Elasticsearch Instance
        run: invoke update-elasticsearch --url=${{ secrets.ELASTICSEARCH_URL }}
